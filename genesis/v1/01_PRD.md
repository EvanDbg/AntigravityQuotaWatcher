# 产品需求文档 (PRD) - Antigravity Quota Watcher

## 1. 产品概述

**产品名称**: Antigravity Quota Watcher
**版本**: v1.0.2
**类型**: VS Code / Antigravity IDE 扩展插件
**作者**: wusimpl
**许可证**: MIT

一个实时监控 Antigravity AI 模型配额使用情况的 IDE 插件，支持状态栏显示、Dashboard 面板、多模型监控、代理配置等功能。

---

## 2. 功能需求

### 2.1 核心监控模块

| ID | 需求 | 状态 | 描述 |
|----|------|------|------|
| [REQ-001] | 实时配额轮询 | ✅ 已完成 | 定时轮询配额使用情况，默认间隔 60 秒 |
| [REQ-002] | 状态栏显示 | ✅ 已完成 | 在 IDE 底部状态栏实时显示模型配额 |
| [REQ-003] | 多种显示模式 | ✅ 已完成 | 支持百分比、进度条、圆点三种显示风格 |
| [REQ-004] | 智能预警 | ✅ 已完成 | 配额不足时通过颜色变化提醒 (绿→黄→红→黑) |
| [REQ-005] | Tooltip 详情 | ✅ 已完成 | 鼠标悬停状态栏显示所有模型配额详情和重置时间 |
| [REQ-006] | 点击刷新 | ✅ 已完成 | 点击状态栏立即刷新配额信息 |

### 2.2 API 接入模块

| ID | 需求 | 状态 | 描述 |
|----|------|------|------|
| [REQ-010] | GET_USER_STATUS 方式 | ✅ 已完成 | 通过本地 Antigravity 服务端口获取配额 |
| [REQ-011] | GOOGLE_API 方式 | ✅ 已完成 | 通过 Google Cloud Code API 获取配额 |
| [REQ-012] | 自动端口检测 | ✅ 已完成 | 自动检测 Antigravity 服务的本地端口 |
| [REQ-013] | 手动重新检测端口 | ✅ 已完成 | 提供命令面板手动触发端口重新检测 |

### 2.3 认证模块

| ID | 需求 | 状态 | 描述 |
|----|------|------|------|
| [REQ-020] | Google OAuth 登录 | ✅ 已完成 | 通过 OAuth 流程登录 Google 账号 |
| [REQ-021] | Token 存储管理 | ✅ 已完成 | 安全存储和管理认证 Token |
| [REQ-022] | 本地登录同步 | ✅ 已完成 | 自动检测 Antigravity IDE 的登录状态并同步 |
| [REQ-023] | Token 提取 | ✅ 已完成 | 从本地 Antigravity 数据库提取认证信息 |
| [REQ-024] | 登出功能 | ✅ 已完成 | 支持从 Google 账号登出 |

### 2.4 Dashboard 面板

| ID | 需求 | 状态 | 描述 |
|----|------|------|------|
| [REQ-030] | 配额概览表格 | ✅ 已完成 | 以表格形式展示所有模型的剩余配额和重置时间 |
| [REQ-031] | 连接状态显示 | ✅ 已完成 | 显示 API 模式、端口、轮询状态等 |
| [REQ-032] | 账号信息显示 | ✅ 已完成 | 显示当前登录账号和订阅计划 |
| [REQ-033] | 快捷操作 | ✅ 已完成 | 刷新配额、重新检测端口、登录/登出等 |
| [REQ-034] | 周限检测 | ✅ 已完成 | 检测各模型池是否触发周配额限制 |

### 2.5 代理与网络

| ID | 需求 | 状态 | 描述 |
|----|------|------|------|
| [REQ-040] | 继承 IDE 代理设置 | ✅ 已完成 | 自动继承 Antigravity/VS Code 的代理配置 |
| [REQ-041] | 独立代理配置 | ✅ 已完成 | 支持为插件单独配置代理 |
| [REQ-042] | 环境变量代理 | ✅ 已完成 | 支持从环境变量自动检测代理 |

### 2.6 国际化

| ID | 需求 | 状态 | 描述 |
|----|------|------|------|
| [REQ-050] | 中文支持 | ✅ 已完成 | 完整的简体中文界面 |
| [REQ-051] | 英文支持 | ✅ 已完成 | 完整的英文界面 |
| [REQ-052] | 自动语言检测 | ✅ 已完成 | 可跟随 IDE 语言设置自动切换 |

### 2.7 平台兼容

| ID | 需求 | 状态 | 描述 |
|----|------|------|------|
| [REQ-060] | Windows amd64 支持 | ✅ 已完成 | 支持 Windows x64 系统 |
| [REQ-061] | macOS 支持 | ✅ 已完成 | 支持 macOS 系统 |
| [REQ-062] | Linux 支持 | ✅ 已完成 | 支持 Linux 系统 (需 lsof/netstat/ss) |
| [REQ-063] | VS Code Fork 支持 | ✅ 已完成 | 支持 WindSurf、Kiro 等 VS Code 衍生 IDE |

---

## 3. 核心验收标准

### AC-001: 配额实时监控
```
Given 用户已安装并激活插件
When 插件检测到 Antigravity 服务端口
Then 状态栏应在 8 秒延迟后开始显示配额信息
And 每隔配置的轮询间隔自动刷新
```

### AC-002: 智能预警
```
Given 用户开启了配额监控
When 某模型配额降至警告阈值以下
Then 状态栏对应模型的指示符颜色应变为黄色
When 配额降至临界阈值以下
Then 指示符颜色应变为红色
When 配额耗尽 (0%)
Then 指示符应显示黑色
```

### AC-003: 周限检测
```
Given 用户在 Dashboard 中点击某模型池的周限检测
When 发送测试请求后收到 429 状态码
And 错误原因为 QUOTA_EXHAUSTED 且重置时间 > 5 小时
Then 应判定为周限触发
```

---

## 4. 非功能需求

| ID | 需求 | 描述 |
|----|------|------|
| [NFR-001] | 首次启动延迟 | 启动后延迟 8 秒再开始监控，避免频繁请求 |
| [NFR-002] | 最低 VS Code 版本 | 要求 VS Code ≥ 1.85.0 |
| [NFR-003] | 日志分级 | 支持 ERROR/WARNING/INFO/DEBUG 四级日志 |
| [NFR-004] | 跨平台兼容 | 通过平台检测器适配不同操作系统的进程检测 |
